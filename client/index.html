<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>slideSpAZe</title>
    <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet'>
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script type="text/javascript" src="http://code.jquery.com/ui/1.10.0/jquery-ui.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.6/p5.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/addons/p5.dom.min.js"></script>
    <script src="js/jquery.ui.touch-punch.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" type="text/css" href="css/slidespz.css">
  </head>
  <body>

    <div id="blueLog" style="position: absolute; width: 300px; height: 225px; background-color: transparent; overflow-y: scroll; left: 200px; top: 200px;" class="synced_draggable">
      <div id="blueTag" style="position: sticky; width: fit-content;"><h3>silver</h3></div>
    </div>
    <div id="redLog" style="position: absolute; width: 300px; height: 225px; background-color: transparent; overflow-y: scroll; left: 500px; top: 300px;" class="synced_draggable">
      <div id="redTag" style="position: sticky; width: fit-content;"><h3>trotter</h3></div>
    </div>
    <div id="yellowLog" style="position: absolute; width: 300px; height: 225px; background-color: transparent; overflow-y: scroll; left: 360px; top: 150px;" class="synced_draggable">
      <div id="yellowTag" style="position: sticky; width: fit-content;"><h3>mango</h3></div>
    </div>

    <div id="slideSpAZe">

      <div id="userFormArea">
        <form id="userForm" action="">
          <input id="username" autocomplete="off" type="text" onclick="spanmegamix(); stickmix();"/><button>login</button>
        </form>
      </div>

      <div id="userlist">
        <h2 id="creaturez"> online creatures</h2>
        <ul class = "list-group" id="users" style="font-style: italic;"></ul>
      </div>

      <div id="thingieBank">
        <div style="position: -webkit-sticky; position: sticky; top: 0;"><h2 onclick="thingieDrawer()" class="drawer"> thingiessss!! </h2></div>
      </div>

    </div>

    <div id="p5Canvas">
      <script src="js/bubbly.js"></script>
    </div>

    <div id="messageFormArea" >
      <div id="mojimix"></div>
        <form id="messageForm" style="position: relative; " action="">
          <input id="m" autocomplete="off"/>
          <button id="sayit" type="submit" style="width: fit-content;">Send</button>
          <button id="redbtn" type="button" class="button" data-color="red" style="background-color: red; ">
          <button id="yellowbtn" type="button" class="button" data-color="#ffcc00" style="background-color: #ffcc00;">
          <button id="bluebtn" type="button" class="button" data-color="#00ccff" style="background-color: #00ccff;">
            <button id="tiny" type="button"  class="pointsize" style="position: relative; width: fit-content; color: white;" data-point="12pt">tiny</button>
            <button id="inbetween" type="button" class="pointsize" style="position: relative; width: fit-content; color: white;" data-point="22pt">inbetween</button>
            <button id="huGe" type="button" class="pointsize" style="position: relative; width: fit-content; color: white;" data-point="42pt">huGe</button>
        </form>
    </div>

    <script>
    var mojiarray = ['ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯', 'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ½', 'ğŸ¸', 'ğŸµ', 'ğŸ™ˆ', 'ğŸ™‰', 'ğŸ™Š', 'ğŸ’', 'ğŸ”', 'ğŸ§', 'ğŸ¦', 'ğŸ¤', 'ğŸ£', 'ğŸ¥', 'ğŸ¦†', 'ğŸ¦…', 'ğŸ¦‰', 'ğŸ¦‡', 'ğŸº', 'ğŸ—', 'ğŸ´', 'ğŸ¦„', 'ğŸ', 'ğŸ›', 'ğŸ¦‹', 'ğŸŒ', 'ğŸ', 'ğŸœ', 'ğŸ¦—', 'ğŸ•·', 'ğŸ•¸', 'ğŸ¦‚', 'ğŸ¢', 'ğŸ', 'ğŸ¦', 'ğŸ¦–', 'ğŸ¦•', 'ğŸ™', 'ğŸ¦‘', 'ğŸ¦', 'ğŸ¦€', 'ğŸ¡', 'ğŸ ', 'ğŸŸ', 'ğŸ¬', 'ğŸ³', 'ğŸ‹', 'ğŸ¦ˆ', 'ğŸŠ', 'ğŸ…', 'ğŸ†', 'ğŸ¦“', 'ğŸ¦', 'ğŸ˜', 'ğŸ¦', 'ğŸª', 'ğŸ«', 'ğŸ¦’', 'ğŸƒ', 'ğŸ‚', 'ğŸ„', 'ğŸ', 'ğŸ–', 'ğŸ', 'ğŸ‘', 'ğŸ', 'ğŸ¦Œ', 'ğŸ•', 'ğŸ©', 'ğŸˆ', 'ğŸ“', 'ğŸ¦ƒ', 'ğŸ•Š', 'ğŸ‡', 'ğŸ', 'ğŸ€', 'ğŸ¿', 'ğŸ¦”', 'ğŸ¾', 'ğŸ‰', 'ğŸ²', 'ğŸŒµ', 'ğŸ„', 'ğŸŒ²', 'ğŸŒ³', 'ğŸŒ´', 'ğŸŒ±', 'ğŸŒ¿', 'â˜˜ï¸', 'ğŸ€', 'ğŸ', 'ğŸ‹', 'ğŸƒ', 'ğŸ‚', 'ğŸ', 'ğŸ„', 'ğŸš', 'ğŸŒ¾', 'ğŸ’', 'ğŸŒ·', 'ğŸŒ¹', 'ğŸ¥€', 'ğŸŒº', 'ğŸŒ¸', 'ğŸŒ¼', 'ğŸŒ»', 'ğŸŒ', 'ğŸŒ', 'ğŸŒ›', 'ğŸŒœ', 'ğŸŒš', 'ğŸŒ•', 'ğŸŒ™', 'ğŸŒ', 'ğŸ’«', 'â­ï¸', 'ğŸŒŸ', 'âœ¨', 'âš¡ï¸', 'â˜„ï¸', 'ğŸ’¥', 'ğŸ”¥', 'ğŸŒª', 'ğŸŒˆ', 'â˜€ï¸', 'ğŸŒ¤', 'â›…ï¸', 'ğŸŒ¥', 'â˜ï¸', 'ğŸŒ¦', 'ğŸŒ§', 'â›ˆ', 'ğŸŒ©', 'ğŸŒ¨', 'â„ï¸', 'ğŸŒ¬', 'ğŸ’¨', 'ğŸ’§', 'ğŸ’¦', 'â˜”ï¸', 'â˜‚ï¸', 'ğŸŒŠ', 'ğŸŒ«'];
    // var stickerzArray = ['gremlin2', 'image', 'beblm', 'cephskin', 'chairshark', 'claybowl', 'compost', 'grog', 'pinkpatch', 'polkaslink', 'posters', 'purple', 'sponges', 'wiggli', 'crispy', 'grenadilla', 'reddd', 'nagai', 'mindgame', 'god', 'godsmoking'];
    var stickerzArray;

    function spanmegamix() {
      var $ele =  $('#mojimix');
      for (i=0; i<mojiarray.length; i++){
         moji = mojiarray[i];
        $ele.append('<span onclick="addemoji(this.innerText)">'+moji+'</span>');
      }
    }

    function addemoji(moji){
      var $entry = $('#m').val();
      $('#m').val($entry+moji);
    }

    $.get('/filenames', function(data){
      stickerzArray = data;
    });

    function stickmix() {
      var $ele = $('#thingieBank');
      for (i=0; i<stickerzArray.length; i++) {
        $ele.append('<div id="sticker'+i+'" style="background-color: transparent; position: relative; float: left;" onclick="slideThingie(this.id)"><img src="assets/'+stickerzArray[i]+'" alt="opsie" class="stuck"/></div>');
      }
    }

    function thingieDrawer() {
      var bank = $('#thingieBank');
      var width = bank.css("width");
      if (width=='480px'){
        $('#thingieBank').animate({width: '142px', height: '42px'});
      } else {
        $('#thingieBank').animate({width: '480px', height: '600px'});
      }
    }

    </script>

    <script>
    //socket script
    var socket = io();
    var count = 0;
    var thingie = 0;

    var offset = 48;
    var logMax = 33;
    var redEntries = [];
    var yellowEntries = [];
    var blueEntries = [];

    $(document).ready(function () {
      var $thisColor = "#00ccff";
      var $pointSize = "22pt";

      $.get('/divData', function(data){

        for(i=0;i<data.length;i++){
          var $div = data[i];
          var $item = $( '<div id="'+$div.id+'" onmouseup="sendDivInfo(this.id);">'+$div.html+'</div>' );
          $($item).appendTo($div.parent);
          $($item).css({
            position: "absolute",
            left: $div.x+"px",
            top: $div.y+"px",
            color: $div.color,
            fontSize: $div.point,
            zIndex: "1"
          });
          $($item).draggable({
            drag: function (event, ui) {
              var coord = $(this).position();
              socket.emit('receive_position', {
                id: $(this).attr('id'),
                x: coord.left,
                y: coord.top
              });
            }
          });
        }

      });

      $('#userForm').submit(function(data){
        var usr = $('#username').val();
        if (usr===""){
        } else {
          $('#userFormArea').hide();
          $('#messageFormArea').show();
          $('#thingieBank').show();
          socket.emit('new user', usr);
        }
        $('#username').val('');
        return false;
      });

      //MESSAGEFORM SUBMIT
      $('.pointsize').click(function(){
        $pointSize = $(this).data('point');
        $('#sayit').css("fontSize", $pointSize);
        $('#m').css("fontSize", $pointSize);
      });

      $('.button').click(function(){
        $thisColor = $(this).data('color');
        $('#sayit').css("background",$thisColor);
      });

      $('#messageForm').submit(function(submit_data){
        socket.emit('chat message', {text: $('#m').val(), color: $thisColor, point: $pointSize});
        $('#m').val('');
        return false;
      });

      //DIV POSITIONS
      socket.on('update_position', function (data) {
        $("#"+data.id).css({
          left: data.x + "px",
          top: data.y + "px"
        });
      });

      $(".synced-draggable").draggable({
        drag: function (event, ui) {
          var coord = $(this).position();
          socket.emit('receive_position', {
            id: $(this).attr('id'),
            x: coord.left,
            y: coord.top
          });
        }
      });

      $('#userlist').draggable( {
        handle: "#creaturez",
        drag: function (event, ui) {
          var coord = $(this).position();
          socket.emit('receive_position', {
            id: $(this).attr('id'),
            x: coord.left,
            y: coord.top
          });
        }
      });

      $('#blueLog').draggable({
        handle: "#blueTag",
        drag: function (event, ui) {
          var coord = $(this).position();
          socket.emit('receive_position', {
            id: $(this).attr('id'),
            x: coord.left,
            y: coord.top
          });
        }
      });
      $('#redLog').draggable({
        handle: "#redTag",
        drag: function (event, ui) {
          var coord = $(this).position();
          socket.emit('receive_position', {
            id: $(this).attr('id'),
            x: coord.left,
            y: coord.top
          });
        }
      });
      $('#yellowLog').draggable({
        handle: "#yellowTag",
        drag: function (event, ui) {
          var coord = $(this).position();
          socket.emit('receive_position', {
            id: $(this).attr('id'),
            x: coord.left,
            y: coord.top
          });
        }
      });

      socket.on('make div', function(data){
        var divID = "#"+data.id;
        var testparent = $(divID).parent();
        if ($(divID).length){
          console.log(testparent);
        } else {
          var $item = $( '<div id="'+data.id+'" onmouseup="sendDivInfo(this.id);">'+data.html+'</div>' );
          $($item).appendTo(data.parent);
          $($item).css({
            position: "absolute",
            color: data.color,
            fontSize: data.point,
            zIndex: "1"
          });
          $($item).draggable({
            drag: function (event, ui) {
              var coord = $(this).position();
              socket.emit('receive_position', {
                id: $(this).attr('id'),
                x: coord.left,
                y: coord.top
              });
            }
          });
        }
      });
      //NEW MESSAGE
      socket.on('chat message', function(entry){

          // var $item = $('<div id="entry'+count+'" style="background-color: transparent; color:'+entry.color+'; position: relative; left: 75px; z-index: 1;" onmousedown="pinDiv(this.id); makeID(this.id);"><strong>'+entry.user+':</strong> '+entry.msg+'</div>');
          var $item = $('<div id="entry'+count+'" style="background-color: transparent; color:'+entry.color+'; position: relative; left: 75px; z-index: 1; font-size:'+entry.point+';" onmousedown="pinDiv(this.id); makeID(this.id);">'+entry.msg+'</div>');


          console.log($($item).css("width"));
          $($item).draggable({
            drag: function (event, ui) {
              var coord = $(this).position();
              socket.emit('receive_position', {
                id: $(this).attr('id'),
                x: coord.left,
                y: coord.top
              });
            }
          });

          if(entry.color == "red"){
            redEntries.push('#entry'+count);
            $('#redLog').append($item);
            var elem = document.getElementById('redLog');
            elem.scrollTop = elem.scrollHeight;
            if(logMax<redEntries.length){
              $(redEntries[0]).remove();
              redEntries.splice(0, 1);
            }
          }else if(entry.color == "#ffcc00"){
            yellowEntries.push('#entry'+count);
            $('#yellowLog').append($item);
            var elem = document.getElementById('yellowLog');
            elem.scrollTop = elem.scrollHeight;
            if(logMax<yellowEntries.length){
              $(yellowEntries[0]).remove();
              yellowEntries.splice(0, 1);
            }
          }else if (entry.color == "#00ccff"){
            blueEntries.push('#entry'+count);
            $('#blueLog').append($item);
            var elem = document.getElementById('blueLog');
            elem.scrollTop = elem.scrollHeight;
            if(logMax<blueEntries.length){
              $(blueEntries[0]).remove();
              blueEntries.splice(0, 1);
            }
          }
          count++;
        });

      socket.on('get users', function(data){
        var html = '';
        for (var i = 0; i < data.length; i++){
          html += '<li class="list-group-item">'+data[i]+'</li>';
        }
        $('#users').html(html);
      });
    });

      function pinDiv(id){
        var div = "#"+id;
        $(div).appendTo('#slideSpAZe');
        $(div).css({
          position: "absolute",
          left: event.pageX,
          top: event.pageY,
          zIndex: "1"
        });
        if(redEntries.includes(div)){
          redEntries.splice(redEntries.indexOf(div), 1);
        } else if(yellowEntries.includes(div)){
          yellowEntries.splice(yellowEntries.indexOf(div), 1);
        } else if(blueEntries.includes(div)){
          blueEntries.splice(blueEntries.indexOf(div), 1);
        }
      }

      // function resize(id) {
      //   var $divID = '#'+id;
      //   var img = $($divID).children();
      //
      //   img.addClass("stickerz");
      //   // img.css("width", "150px");
      //   console.log(img);
      // }

      function slideThingie(id){
        var $divID = '#'+id;
        var $html = $($divID).html();
        var $item = $( '<div id="thingie'+thingie+'" style="left: 50px; top: 50px; z-index: 1;" onmousedown="makeID(this.id);">'+$html+'</div>' );
        thingie++;

        $($item).appendTo('#slideSpAZe');
        $($item).addClass("synced-draggable");
        $($item).draggable({
          drag: function (event, ui) {
            var coord = $(this).position();
            socket.emit('receive_position', {
              id: $(this).attr('id'),
              x: coord.left,
              y: coord.top
            });
          }
        });
      }

      function sendDivInfo(id) {
        var div = '#'+id;
        var coord = $(div).position();
        var htmlString = $(div).html();
        var parentNode = '#'+$(div).parent().attr("id");
        var thisColor = $(div).css("color");
        var thisPoint = $(div).css("font-size");

        $.post('/divs',
          {"id": id, "x": coord.left, "y": coord.top, "html": htmlString, "parent": parentNode, "color": thisColor, "point": thisPoint},
            function(data, status, jqXHR){
              console.log(data);
        });
      }

      function makeID(id) {
        var div = '#'+id;
        var htmlString = $(div).html();
        var parentNode = '#'+$(div).parent().attr("id");
        var thisColor = $(div).css("color");
        var thisPoint = $(div).css("font-size");

        var number = Math.random()
        number.toString(36);
        var logID = number.toString(36).substr(2, 9);

        $(div).removeAttr("onmousedown");
        $(div).attr("id", logID);
        $("#"+logID).attr("onmouseup", "sendDivInfo(this.id);");

        socket.emit('new div', {"id": logID, "html": htmlString, "parent": parentNode, "color": thisColor, "point": thisPoint});
      };

    </script>
  </body>
</html>
